<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="TONTOON">
    <title>TONTOON - Streaming Film Terlengkap</title>
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Font Google: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #2E073F;
            --primary-nav: #7A1CAC;
            --accent-hover: #AD49E1;
            --text-color: #FFFFFF;
            --card-bg: rgba(122, 28, 172, 0.2);
            --glass-bg: rgba(122, 28, 172, 0.15);
            --dark-overlay: rgba(46, 7, 63, 0.85);
            --carousel-overlay: rgba(46, 7, 63, 0.95);
        }

        [data-theme="light"] {
            --primary-bg: #ffffff;
            --primary-nav: #7A1CAC;
            --accent-hover: #AD49E1;
            --text-color: #000000;
            --card-bg: rgba(235, 211, 248, 0.5);
            --glass-bg: rgba(122, 28, 172, 0.1);
            --dark-overlay: rgba(248, 249, 250, 0.95);
            --carousel-overlay: rgba(248, 249, 250, 0.95);
        }

        /* Adjust text color on images for light theme for better readability */
        [data-theme="light"] .movie-overlay,
        [data-theme="light"] .carousel-title,
        [data-theme="light"] .carousel-info,
        [data-theme="light"] .carousel-genres,
        [data-theme="light"] .carousel-genre,
        [data-theme="light"] .carousel-rating,
        [data-theme="light"] .carousel-year {
            color: #FFFFFF !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Glassmorphism Effect */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Navbar */
        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text-color) !important;
        }
        
        .nav-link {
            color: var(--text-color) !important;
            font-weight: 500;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--accent-hover) !important;
        }
        
        /* Bottom Navigation untuk mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: none;
            padding: 0.8rem 0;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.8rem;
        }
        
        .bottom-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
        }
        
        .bottom-nav-item.active {
            color: var(--accent-hover);
        }
        
        /* Movie Cards */
        .movie-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            aspect-ratio: 2/3;
            cursor: pointer;
            border: none;
            width: 180px;
            flex-shrink: 0;
        }
        
        .movie-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .movie-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 1rem;
            color: var(--text-color);
        }
        
        .movie-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.3rem;
        }
        
        .movie-meta {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* Carousel Trending */
        .carousel-trending {
            height: 450px;
            border-radius: 32px;
            overflow: hidden;
            margin-bottom: 2rem;
            position: relative;
        }

        .carousel-item {
            height: 450px;
            position: relative;
            padding: 20px;
        }

        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .carousel-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--carousel-overlay), transparent);
            padding: 2rem;
        }
        
        .carousel-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .carousel-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .carousel-rating {
            background-color: var(--accent-hover);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .carousel-year {
            font-size: 1.2rem;
        }
        
        .carousel-genres {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .carousel-genre {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        .carousel-controls {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 10;
        }
        
        .carousel-btn {
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.5);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .carousel-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .carousel-indicators-custom {
            position: absolute;
            bottom: 1rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .carousel-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .carousel-indicator.active {
            background-color: var(--accent-hover);
            transform: scale(1.2);
        }
        
        /* Skeleton Loading */
        .skeleton {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            animation: pulse 1.5s infinite ease-in-out;
            aspect-ratio: 2/3;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Custom Video Player */
        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .video-player {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .video-player-container:hover .video-controls {
            transform: translateY(0);
        }
        
        /* Shared Element Transition */
        .shared-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Scrollbars */
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 0.5rem 0;
            gap: 1rem;
        }
        
        .horizontal-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .horizontal-scroll::-webkit-scrollbar-thumb {
            background-color: var(--accent-hover);
            border-radius: 3px;
        }
        
        /* Forms */
        .auth-form {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-control {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
        }
        
        .form-control:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-hover);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(173, 73, 225, 0.25);
        }
        
        /* Override Bootstrap text classes for theme support */
        .text-muted {
            color: var(--text-color) !important;
            opacity: 0.6;
        }

        .text-primary {
            color: var(--accent-hover) !important;
        }

        .text-warning {
            color: #ffc107 !important;
        }

        /* Ensure all text elements use theme colors */
        h1, h2, h3, h4, h5, h6, p, span, div, a, li, td, th, label, input, textarea, select, button {
            color: var(--text-color);
        }

        /* Specific overrides for elements that might not inherit */
        .navbar-toggler {
            color: var(--text-color) !important;
        }

        .modal-title {
            color: var(--text-color) !important;
        }

        .form-label {
            color: var(--text-color) !important;
        }

        .table {
            color: var(--text-color);
        }

        .badge {
            color: var(--text-color);
        }

        /* Search Results Container */
        .search-results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
            justify-items: center;
        }

        .no-results {
            grid-column: 1 / -1;
        }

        /* Utility Classes */
        .page-transition {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .back-button {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .back-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .back-button:hover::before {
            left: 100%;
        }

        .back-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(173, 73, 225, 0.3);
            border-color: var(--accent-hover);
        }

        .back-button:active {
            transform: translateY(0) scale(0.98);
        }

        .back-button i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .back-button:hover i {
            transform: translateX(-2px);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .bottom-nav {
                display: flex;
                justify-content: space-around;
            }

            .navbar-nav {
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 1rem;
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                z-index: 1000;
            }

            .navbar-nav.show {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }

            .movie-card {
                width: 150px;
                flex-shrink: 0;
            }

            .carousel-trending {
                height: 300px;
            }

            .carousel-item {
                height: 300px;
                padding: 15px;
            }

            .carousel-overlay {
                padding: 1.5rem;
            }

            .carousel-title {
                font-size: 1.8rem;
            }

            .carousel-info {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .carousel-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 576px) {
            .auth-form {
                padding: 1.5rem;
            }
            
            .carousel-trending {
                height: 250px;
            }
            
            .carousel-item {
                height: 250px;
            }
            
            .carousel-overlay {
                padding: 1rem;
            }
            
            .carousel-title {
                font-size: 1.5rem;
            }
            
            .carousel-info {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Aplikasi Container -->
    <div id="app">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg glass fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#" onclick="loadPage('home')">
                    <img src="assets/logotontoon.png" alt="TONTOON Logo" style="height: 30px; margin-right: 10px;">
                    TONTOON
                </a>



                <div class="navbar-nav d-none d-lg-flex" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadPage('home')"><i class="fas fa-home me-1"></i> Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadPage('search')"><i class="fas fa-search me-1"></i> Search</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadPage('watchlist')"><i class="fas fa-bookmark me-1"></i> Watchlist</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="loadPage('history')"><i class="fas fa-history me-1"></i> History</a>
                        </li>

                        <li class="nav-item">
                            <button class="btn btn-link nav-link ms-2" id="theme-toggle">
                                <i class="fas fa-moon"></i>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Main Content Area -->
        <main class="container-fluid mt-8 pt-5 pb-5" id="main-content">
            <!-- Konten akan dimuat secara dinamis di sini -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Memuat aplikasi...</p>
            </div>
        </main>
        
        <!-- Bottom Navigation untuk Mobile -->
        <div class="bottom-nav">
            <a href="#" class="bottom-nav-item active" onclick="loadPage('home'); setActiveNav(this)">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="loadPage('search'); setActiveNav(this)">
                <i class="fas fa-search"></i>
                <span>Search</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="loadPage('watchlist'); setActiveNav(this)">
                <i class="fas fa-bookmark"></i>
                <span>Watchlist</span>
            </a>


        </div>
    </div>
    
    <!-- Modal untuk Login -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Login ke TONTOON</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Remember Me</label>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Login</button>
                        </div>
                        <div class="text-center mt-3">
                            <p>Belum punya akun? <a href="#" onclick="showRegister()">Register</a></p>
                            <p><a href="#" onclick="showForgotPassword()">Lupa Password?</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Register -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Buat Akun TONTOON</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerName" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" minlength="6" required>
                            <div class="form-text">Password minimal 6 karakter</div>
                        </div>
                        <div class="mb-3">
                            <label for="registerConfirmPassword" class="form-label">Konfirmasi Password</label>
                            <input type="password" class="form-control" id="registerConfirmPassword" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Register</button>
                        </div>
                        <div class="text-center mt-3">
                            <p>Sudah punya akun? <a href="#" onclick="showLogin()">Login</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal untuk Forgot Password -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content glass border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Reset Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="forgotPasswordForm">
                        <div class="mb-3">
                            <label for="forgotEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="forgotEmail" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Kirim Link Reset</button>
                        </div>
                        <div class="text-center mt-3">
                            <p><a href="#" onclick="showLogin()">Kembali ke Login</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Aplikasi JavaScript -->
    <script>
        // ==================== KONFIGURASI PWA ====================
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        
        
        // ==================== SISTEM AUTHENTIKASI ====================
        // Hash password sederhana
        function simpleHash(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }
        
        // Inisialisasi data user di localStorage
        function initUsers() {
            if (!localStorage.getItem('tontoon_users')) {
                // Buat user default untuk testing
                const defaultUsers = [
                    {
                        id: 1,
                        name: "User Demo",
                        email: "demo@tontoon.com",
                        password: simpleHash("demo123"), // password: demo123
                        joinDate: new Date().toISOString(),
                        watchlist: [],
                        history: [],
                        profilePicture: null,
                        preferences: {
                            theme: "dark",
                            autoPlay: true,
                            quality: "720p"
                        }
                    }
                ];
                localStorage.setItem('tontoon_users', JSON.stringify(defaultUsers));
            }
            
            // Inisialisasi session
            if (!localStorage.getItem('tontoon_session')) {
                localStorage.setItem('tontoon_session', JSON.stringify({}));
            }
        }
        
        // Fungsi untuk mendapatkan user dari localStorage
        function getUsers() {
            return JSON.parse(localStorage.getItem('tontoon_users')) || [];
        }
        
        // Fungsi untuk menyimpan user ke localStorage
        function saveUsers(users) {
            localStorage.setItem('tontoon_users', JSON.stringify(users));
        }
        
        // Fungsi untuk mendapatkan session aktif
        function getSession() {
            return JSON.parse(localStorage.getItem('tontoon_session'));
        }
        
        // Fungsi untuk menyimpan session
        function saveSession(user) {
            const session = {
                userId: user.id,
                email: user.email,
                name: user.name,
                loggedInAt: new Date().toISOString()
            };
            localStorage.setItem('tontoon_session', JSON.stringify(session));
        }
        
        // Fungsi untuk logout
        function logout() {
            localStorage.setItem('tontoon_session', JSON.stringify({}));
            showLoginModal();
            loadPage('home');
        }
        
        // Fungsi untuk cek apakah user sudah login
        function isLoggedIn() {
            const session = getSession();
            return session && session.userId;
        }
        
        // ==================== DATA FILM ====================
        // Daftar film yang tersedia
        const movies = [
            {
                id: 1,
                title: "Avengers",
                year: 2012,
                rating: 8.0,
                genre: ["Action", "Adventure", "Sci-Fi"],
                duration: "143 min",
                poster: "assets/avanger.jpg",
                banner: "assets/avanger.jpg",
                director: "Joss Whedon",
                cast: "Robert Downey Jr., Chris Evans, Mark Ruffalo, Chris Hemsworth, Scarlett Johansson",
                releaseDate: "May 4, 2012",
                language: "English",
                description: "Dalam installment pertama dari saga superhero epik Marvel, Nick Fury, direktur S.H.I.E.L.D., merakit tim individu luar biasa untuk membentuk inisiatif Avengers. Ketika Loki, saudara angkat Thor, mencuri Tesseract dan mengancam untuk memperbudak umat manusia, Iron Man, Captain America, Hulk, Thor, Black Widow, dan Hawkeye harus bersatu untuk menghentikannya. Film inovatif ini memperkenalkan konsep Avengers sebagai pahlawan terkuat Bumi, menggabungkan aksi berisiko tinggi dengan drama yang didorong karakter dan menetapkan panggung untuk narasi saling terkait Marvel Cinematic Universe."
            },
            {
                id: 2,
                title: "Avengers End Game",
                year: 2019,
                rating: 8.4,
                genre: ["Action", "Adventure", "Drama"],
                duration: "181 min",
                poster: "assets/Avangers End Game (2019).jpg",
                banner: "assets/Avangers End Game (2019).jpg",
                director: "Anthony Russo, Joe Russo",
                cast: "Robert Downey Jr., Chris Evans, Mark Ruffalo, Chris Hemsworth, Scarlett Johansson",
                releaseDate: "April 26, 2019",
                language: "English",
                description: "Mengikuti peristiwa menghancurkan dari Avengers: Infinity War, alam semesta hancur. Dengan bantuan sekutu yang tersisa, Avengers berkumpul sekali lagi dalam balapan melawan waktu untuk membalikkan tindakan Thanos dan memulihkan keseimbangan alam semesta. Kesimpulan epik untuk Infinity Saga ini menampilkan lengkungan karakter emosional, pertempuran masif, dan puncak dari lebih dari satu dekade narasi Marvel. Film ini mengeksplorasi tema kehilangan, penebusan, dan kekuatan persatuan saat pahlawan dari seluruh MCU berkumpul untuk berdiri terakhir."
            },
            {
                id: 3,
                title: "Avengers Infinity War",
                year: 2018,
                rating: 8.4,
                genre: ["Action", "Adventure", "Sci-Fi"],
                duration: "149 min",
                poster: "assets/Avangers infinity war.jpg",
                banner: "assets/Avangers infinity war.jpg",
                director: "Anthony Russo, Joe Russo",
                cast: "Robert Downey Jr., Chris Hemsworth, Mark Ruffalo, Chris Evans, Scarlett Johansson",
                releaseDate: "April 27, 2018",
                language: "English",
                description: "Perjalanan sinematik yang belum pernah terjadi sebelumnya sepuluh tahun dalam pembuatan dan meliputi seluruh Marvel Cinematic Universe, Avengers: Infinity War menyatukan Avengers dan Guardians of the Galaxy dalam pertarungan epik melawan Thanos. Saat pencarian Mad Titan untuk Infinity Stones mengancam untuk menghapus setengah dari semua kehidupan di alam semesta, pahlawan harus menghadapi ketakutan terdalam mereka dan membuat pengorbanan yang tak terbayangkan. Film spektakuler secara visual ini mengeksplorasi konsekuensi kekuatan dan kerapuhan eksistensi di seluruh dunia."
            },
            {
                id: 4,
                title: "Badlands",
                year: 2024,
                rating: 7.2,
                genre: ["Action", "Thriller"],
                duration: "115 min",
                poster: "assets/badlands.jpg",
                banner: "assets/badlands.jpg",
                director: "Justin Lee",
                cast: "Jamie Foxx, Scott Adkins, Lana Rhoades, Trace Adkins",
                releaseDate: "March 29, 2024",
                language: "English",
                description: "Di padang gurun terpencil dan tak kenal ampun, seorang penembak jitu legendaris telah mengubah silo rudal yang dinonaktifkan menjadi benteng tak tertembus, menjadi pria paling dicari di dunia. Ketika seorang operatif terampil dikirim untuk menghilangkannya, apa yang dimulai sebagai misi pembunuhan langsung berkembang menjadi permainan kelangsungan hidup yang mematikan. Saat pemburu menjadi yang diburu, kedua pria harus menavigasi medan berbahaya, saling mengalahkan, dan menghadapi setan mereka sendiri dalam thriller psikologis intens ini yang mempertanyakan sifat keadilan dan balas dendam."
            },
            {
                id: 5,
                title: "Battle of the Gods",
                year: 2023,
                rating: 7.5,
                genre: ["Action", "Fantasy"],
                duration: "128 min",
                poster: "assets/Battle of the Gods.jpg",
                banner: "assets/Battle of the Gods.jpg",
                director: "Masahiro Hosoda",
                cast: "Masako Nozawa, Ryō Horikawa, Toshio Furukawa, Mayumi Tanaka",
                releaseDate: "March 30, 2013",
                language: "Japanese",
                description: "Beerus, Dewa Penghancuran, turun ke Bumi dengan ajudan malaikatnya Whis, mencari Super Saiyan God legendaris yang diproklamasikan sebagai pejuang terkuat di alam semesta. Goku dan teman-temannya harus berlatih keras untuk membuka potensi tersembunyi mereka dan melindungi planet mereka dari kehancuran. Film Dragon Ball epik ini menampilkan urutan seni bela diri yang menakjubkan, pengembangan karakter, dan pengenalan transformasi baru yang kuat. Cerita ini mengeksplorasi tema persahabatan, ketekunan, dan pengejaran kekuatan yang tak ada habisnya di hadapan peluang yang luar biasa."
            },
            { id: 6, title: "Beekeeper", year: 2024, rating: 6.7, genre: ["Action", "Thriller"], duration: "105 min", poster: "assets/beekeeper.jpg", banner: "assets/beekeeper.jpg", description: "Adam Clay, mantan operatif untuk organisasi rahasia yang dikenal hanya sebagai 'Beekeepers,' hidup tenang sebagai peternak lebah setelah pensiun dari masa lalu berbahayanya. Ketika tetangga baiknya Eloise dibunuh oleh kartel narkoba kejam, Adam ditarik kembali ke dunia kekerasan dan intrik. Menggunakan pelatihan elitnya dan rasa keadilan yang tak tergoyahkan, ia memulai pencarian balas dendam yang tak kenal lelah yang mengungkap jaringan kriminal yang luas. Thriller aksi penuh ini mengeksplorasi tema kesetiaan, penebusan, dan garis kabur antara benar dan salah di dunia yang korup." },
            { id: 7, title: "Black Adam", year: 2022, rating: 6.3, genre: ["Action", "Adventure", "Fantasy"], duration: "125 min", poster: "assets/black adam .jpg", banner: "assets/black adam .jpg", description: "Hampir 5.000 tahun setelah ia diberi kekuatan mahakuasa dewa-dewa kuno—dan dipenjara dengan cepat—Black Adam dibebaskan dari makam duniawinya, siap untuk melepaskan bentuk keadilan uniknya ke dunia modern. Sebagai anti-pahlawan kuat dengan kemampuan seperti dewa, ia bertabrakan dengan Justice Society dan harus memutuskan apakah akan merangkul sisi gelapnya atau menjadi pahlawan yang dibutuhkan dunia. Film ini menyelami tema kekuatan, warisan, dan identitas budaya sambil memberikan urutan aksi spektakuler dan mengeksplorasi kompas moral kompleks karakter." },
            { id: 8, title: "Blade Runner 2049", year: 2017, rating: 8.0, genre: ["Drama", "Mystery", "Sci-Fi"], duration: "164 min", poster: "assets/Blade Runner 2049.jpg", banner: "assets/Blade Runner 2049.jpg", description: "Tiga puluh tahun setelah peristiwa film asli, seorang blade runner baru, Petugas LAPD K, mengungkap rahasia yang lama terkubur yang berpotensi menjerumuskan sisa masyarakat ke dalam kekacauan. Penemuannya membawanya dalam pencarian untuk menemukan Rick Deckard, mantan blade runner yang hilang selama 30 tahun. Saat K mendalami misteri lebih dalam, ia mulai mempertanyakan identitasnya sendiri dan sifat kemanusiaan itu sendiri. Sekuel yang menakjubkan secara visual ini mengeksplorasi tema kesadaran, kehendak bebas, dan apa artinya menjadi manusia di dunia yang didominasi oleh kecerdasan buatan." },
            { id: 9, title: "Bullet Train", year: 2022, rating: 7.3, genre: ["Action", "Comedy", "Thriller"], duration: "127 min", poster: "assets/Bullet Train.jpg", banner: "assets/Bullet Train.jpg", description: "Lima pembunuh naik kereta peluru berkecepatan tinggi dari Tokyo ke Morioka dengan misi yang tampaknya tidak terkait. Saat kereta melaju melalui pedesaan Jepang, jalan mereka mulai bersilangan dengan cara yang tak terduga dan lucu, mengarah ke serangkaian konfrontasi yang meningkat. Apa yang dimulai sebagai tugas individu dengan cepat menjadi permainan kucing-kucingan yang mematikan di mana tidak ada yang seperti yang terlihat. Thriller aksi-komedi ini mencampur pertarungan bensin tinggi dengan dialog cerdas dan twist tak terduga, menciptakan pengalaman sinematik unik." },
            { id: 10, title: "CAPTAIN MARVEL", year: 2019, rating: 6.8, genre: ["Action", "Adventure", "Sci-Fi"], duration: "123 min", poster: "assets/CAPTAIN MARVEL.jpg", banner: "assets/CAPTAIN MARVEL.jpg", description: "Set in the 1990s, Carol Danvers becomes one of the universe's most powerful heroes when Earth is caught in the middle of a galactic war between two alien races. As she discovers her true identity and unlocks her incredible powers, Carol must confront her past and decide where her loyalties lie. This empowering story explores themes of self-discovery, female strength, and the fight for justice across the cosmos. The film introduces Captain Marvel as a formidable force in the Marvel Cinematic Universe with spectacular action sequences and emotional depth." },
            { id: 11, title: "DUNE part two", year: 2024, rating: 8.7, genre: ["Action", "Adventure", "Drama"], duration: "166 min", poster: "assets/DUNE part two.jpg", banner: "assets/DUNE part two.jpg", description: "Paul Atreides unites with Chani and the Fremen while seeking revenge against the conspirators who destroyed his family. As he embraces his destiny as the prophesied leader of the native people of Arrakis, Paul must navigate the complex politics of the desert planet and the galaxy at large. This epic continuation of Frank Herbert's masterpiece explores themes of destiny, ecology, religion, and power in a richly detailed sci-fi universe. With stunning visuals and a compelling narrative, the film continues the saga of political intrigue and interstellar conflict." },
            { id: 12, title: "Extraction", year: 2020, rating: 6.7, genre: ["Action", "Thriller"], duration: "117 min", poster: "assets/Extraction.jpg", banner: "assets/Extraction.jpg", description: "Tyler Rake, a fearless black-market mercenary, embarks on the most deadly extraction of his career when he's enlisted to rescue the kidnapped son of an imprisoned international crime lord. Deep in the heart of Bangladesh, in a place where no one thinks he can get out alive, Rake must navigate treacherous urban landscapes, evade ruthless enemies, and confront his own demons. This intense action thriller explores themes of redemption, family, and the cost of violence in a world where morality is often gray." },
            { id: 13, title: "Fast X", year: 2023, rating: 5.8, genre: ["Action", "Adventure", "Crime"], duration: "141 min", poster: "assets/Fast X.jpg", banner: "assets/Fast X.jpg", description: "Dom Toretto and his family are targeted by the vengeful son of drug kingpin Hernan Reyes, who wants revenge for his father's death. As Dante Reyes unleashes a campaign of terror that stretches from Rome to Rio de Janeiro, the crew must come together for one last job to stop him. This high-octane installment of the Fast & Furious franchise features jaw-dropping car chases, family drama, and the culmination of over two decades of storytelling. The film explores themes of legacy, loyalty, and the unbreakable bonds that define the Toretto family." },
            {
                id: 14,
                title: "Furiosa A MAD MAX SAGA",
                year: 2024,
                rating: 8.1,
                genre: ["Action", "Adventure", "Sci-Fi"],
                duration: "148 min",
                poster: "assets/Furiosa A MAD MAX SAGA.jpg",
                banner: "assets/Furiosa A MAD MAX SAGA.jpg",
                director: "George Miller",
                cast: "Anya Taylor-Joy, Chris Hemsworth, Tom Burke, Nathan Jones",
                releaseDate: "May 24, 2024",
                language: "English",
                description: "Set in the post-apocalyptic wasteland of a dystopian future, this film tells the origin story of the formidable warrior Furiosa before she crossed paths with Mad Max. As a young woman, Furiosa is abducted from her home and raised in the Citadel, a fortress ruled by the tyrannical Immortan Joe. Her journey of survival, rebellion, and transformation unfolds against a backdrop of relentless desert warfare and societal collapse. This visually stunning prequel explores themes of freedom, resilience, and the human spirit's capacity for change in the face of unimaginable adversity."
            },
            {
                id: 15,
                title: "G.I Joe 4 Ever Vigilant",
                year: 2024,
                rating: 6.5,
                genre: ["Action", "Adventure", "Sci-Fi"],
                duration: "120 min",
                poster: "assets/G.I Joe 4 Ever Vigilant.jpg",
                banner: "assets/G.I Joe 4 Ever Vigilant.jpg",
                director: "Jonathan Liebesman",
                cast: "Dwayne Johnson, Channing Tatum, Adrianne Palicki, Ray Park",
                releaseDate: "March 28, 2013",
                language: "English",
                description: "The elite G.I. Joe team returns to combat the terrorist organization Cobra in this action-packed adventure. Led by General Hawk, the Joes must thwart Cobra's latest scheme to unleash chaos on a global scale. Featuring high-tech gadgets, intense combat sequences, and larger-than-life characters, the film showcases the ongoing battle between good and evil. As new threats emerge and old alliances are tested, the Joes must adapt and evolve to maintain their vigilant defense of freedom and justice around the world."
            },
            {
                id: 16,
                title: "HOBBS & SHAW",
                year: 2019,
                rating: 6.5,
                genre: ["Action", "Adventure", "Thriller"],
                duration: "137 min",
                poster: "assets/HOBBS & SHAW.jpg",
                banner: "assets/HOBBS & SHAW.jpg",
                director: "David Leitch",
                cast: "Dwayne Johnson, Jason Statham, Idris Elba, Vanessa Kirby",
                releaseDate: "August 2, 2019",
                language: "English",
                description: "Lawman Luke Hobbs and outcast Deckard Shaw form an unlikely alliance when a cybernetically enhanced terrorist known as Brixton threatens global security. What begins as a high-stakes mission to stop a deadly virus from being unleashed evolves into a personal vendetta that spans multiple continents. This explosive Fast & Furious spin-off features over-the-top action, witty banter, and the chemistry between Dwayne Johnson and Jason Statham. The film explores themes of redemption, brotherhood, and the gray areas between law enforcement and vigilantism."
            },
            {
                id: 17,
                title: "Jhon Wick Chapter 4",
                year: 2023,
                rating: 7.7,
                genre: ["Action", "Crime", "Thriller"],
                duration: "169 min",
                poster: "assets/Jhon Wick Chapter 5.jpg",
                banner: "assets/Jhon Wick Chapter 5.jpg",
                director: "Chad Stahelski",
                cast: "Keanu Reeves, Laurence Fishburne, George Georgiou, Lance Reddick",
                releaseDate: "March 24, 2023",
                language: "English",
                description: "John Wick uncovers a path to defeating The High Table, the shadowy international assassins' guild that has put a $40 million bounty on his head. But before he can earn his freedom, Wick must face off against a new enemy with powerful alliances across the globe and teams of the world's deadliest killers on his trail. This visually spectacular installment features breathtaking action sequences, intricate fight choreography, and the continued evolution of Wick's legendary status. The film delves into themes of legacy, honor, and the inescapable pull of violence."
            },
            {
                id: 18,
                title: "Mission Impossible - Dead Reckoning Part 1",
                year: 2023,
                rating: 7.7,
                genre: ["Action", "Adventure", "Thriller"],
                duration: "163 min",
                poster: "assets/Mission Impossible – Dead Reckoning Part One.jpg",
                banner: "assets/Mission Impossible – Dead Reckoning Part One.jpg",
                director: "Christopher McQuarrie",
                cast: "Tom Cruise, Hayley Atwell, Ving Rhames, Simon Pegg",
                releaseDate: "July 12, 2023",
                language: "English",
                description: "Ethan Hunt and his IMF team embark on their most dangerous mission yet: to track down a terrifying new weapon that threatens all of humanity before it falls into the wrong hands. As the team races against time across the globe, they must navigate treacherous alliances, deadly betrayals, and impossible odds. This pulse-pounding spy thriller features Tom Cruise performing his own stunts in breathtaking sequences, including a motorcycle chase through the streets of Rome and a cliff-hanging helicopter rescue. The film explores themes of trust, sacrifice, and the thin line between hero and villain."
            },
            {
                id: 19,
                title: "The Batman",
                year: 2022,
                rating: 7.8,
                genre: ["Action", "Crime", "Drama"],
                duration: "176 min",
                poster: "assets/The Batman (2022).jpg",
                banner: "assets/The Batman (2022).jpg",
                director: "Matt Reeves",
                cast: "Robert Pattinson, Zoë Kravitz, Jeffrey Wright, Colin Farrell",
                releaseDate: "March 4, 2022",
                language: "English",
                description: "In his second year of fighting crime, Batman uncovers corruption in Gotham City that connects to his own family while facing a serial killer known as the Riddler. As Bruce Wayne wrestles with his dual identity and the psychological toll of his crusade, he must navigate the city's underworld and question everything he believes about justice. This dark, atmospheric take on the Batman mythos explores themes of trauma, morality, and the corrupting influence of power. With stunning visuals and a compelling performance by Robert Pattinson, the film reimagines the Dark Knight for a new generation."
            },
            {
                id: 20,
                title: "Wonder Woman",
                year: 2017,
                rating: 7.4,
                genre: ["Action", "Adventure", "Fantasy"],
                duration: "141 min",
                poster: "assets/Wonder Woman.jpg",
                banner: "assets/Wonder Woman.jpg",
                director: "Patty Jenkins",
                cast: "Gal Gadot, Chris Pine, Robin Wright, Danny Huston",
                releaseDate: "June 2, 2017",
                language: "English",
                description: "Before she was Wonder Woman, she was Diana, princess of the Amazons, trained to be an unconquerable warrior. Raised on a sheltered island paradise, Diana's life is changed forever when an American pilot crashes on their shores and tells of a massive conflict raging in the outside world. Defying her mother's wishes, Diana leaves her home to fight in World War I, discovering her full powers and true destiny along the way. This empowering origin story explores themes of feminism, peace, and the human capacity for both destruction and compassion."
            }
        ];
        
        // ==================== FUNGSI UTILITAS ====================
        // Set active nav untuk bottom navigation
        function setActiveNav(clickedElement) {
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            clickedElement.classList.add('active');
        }
        
        // Toggle tema gelap/terang
        function toggleTheme() {
            const currentTheme = document.documentElement.dataset.theme || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            console.log('Toggling theme from', currentTheme, 'to', newTheme);
            document.documentElement.dataset.theme = newTheme;
            localStorage.setItem('tontoon_theme', newTheme);

            // Update icon tema navbar
            const themeIcon = document.querySelector('#theme-toggle i');
            if (themeIcon) {
                themeIcon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            }

            // Update icon tema mobile
            const mobileThemeIcon = document.querySelector('#mobile-theme-icon');
            if (mobileThemeIcon) {
                mobileThemeIcon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            }

            // Update switch di profile
            const themeSwitch = document.querySelector('#themeSwitch');
            if (themeSwitch) {
                themeSwitch.checked = newTheme === 'light';
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const navbarNav = document.querySelector('.navbar-nav');
            if (navbarNav) {
                navbarNav.classList.toggle('show');
            }
        }

        // Update mobile profile image
        function updateMobileProfileImage() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);

            const mobileProfileBtn = document.getElementById('mobileProfileBtn');
            const mobileProfileImg = document.getElementById('mobileProfileImg');

            if (user && mobileProfileBtn && mobileProfileImg) {
                if (user.profilePicture) {
                    mobileProfileImg.src = user.profilePicture;
                } else {
                    mobileProfileImg.src = 'https://via.placeholder.com/30x30/7A1CAC/FFFFFF?text=U';
                }
                mobileProfileBtn.style.display = 'block';
            } else if (mobileProfileBtn) {
                mobileProfileBtn.style.display = 'none';
            }
        }
        
        // Load tema dari localStorage
        function loadTheme() {
            const savedTheme = 'light'; // Force light theme by default
            document.documentElement.dataset.theme = savedTheme;

            // Update icon tema navbar
            const themeIcon = document.querySelector('#theme-toggle i');
            if (themeIcon) {
                themeIcon.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            }

            // Update icon tema mobile
            const mobileThemeIcon = document.querySelector('#mobile-theme-icon');
            if (mobileThemeIcon) {
                mobileThemeIcon.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
            }

            // Update switch di profile
            const themeSwitch = document.querySelector('#themeSwitch');
            if (themeSwitch) {
                themeSwitch.checked = savedTheme === 'light';
            }
        }
        
        // Format rating
        function formatRating(rating) {
            return rating.toFixed(1);
        }
        
        // Generate elemen movie card
        function generateMovieCard(movie) {
            return `
                <div class="movie-card shared-transition" onclick="showMovieDetail(${movie.id})">
                    <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
                    <div class="movie-overlay">
                        <div class="movie-title">${movie.title}</div>
                        <div class="movie-meta">
                            <span>${movie.year}</span> •
                            <span><i class="fas fa-star text-warning"></i> ${formatRating(movie.rating)}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==================== FUNGSI MODAL ====================
        let loginModal, registerModal, forgotPasswordModal;
        
        // Inisialisasi modal
        function initModals() {
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
        }
        
        // Tampilkan modal login
        function showLoginModal() {
            loginModal.show();
        }
        
        // Tampilkan modal register
        function showRegisterModal() {
            registerModal.show();
        }
        
        // Tampilkan modal forgot password
        function showForgotPasswordModal() {
            forgotPasswordModal.show();
        }
        
        // Switch ke modal login
        function showLogin() {
            registerModal.hide();
            forgotPasswordModal.hide();
            loginModal.show();
        }
        
        // Switch ke modal register
        function showRegister() {
            loginModal.hide();
            forgotPasswordModal.hide();
            registerModal.show();
        }
        
        // Switch ke modal forgot password
        function showForgotPassword() {
            loginModal.hide();
            registerModal.hide();
            forgotPasswordModal.show();
        }
        
        // ==================== FUNGSI HALAMAN ====================
        // Halaman saat ini
        let currentPage = 'home';
        let pageHistory = [];
        let carouselInterval;
        
        // Fungsi untuk memuat halaman
        function loadPage(page, pushToHistory = true) {
            // Jika belum login, tampilkan modal login kecuali untuk halaman home
            if (!isLoggedIn() && page !== 'home') {
                showLoginModal();
                return;
            }
            
            // Simpan halaman sebelumnya ke history jika diperlukan
            if (pushToHistory && currentPage !== page) {
                pageHistory.push(currentPage);
            }
            
            currentPage = page;
            
            // Sembunyikan semua modal
            if (loginModal) loginModal.hide();
            if (registerModal) registerModal.hide();
            if (forgotPasswordModal) forgotPasswordModal.hide();
            
            // Clear carousel interval jika ada
            if (carouselInterval) {
                clearInterval(carouselInterval);
            }
            
            // Tampilkan loading
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Memuat halaman...</p></div>';
            
            // Set timeout untuk simulasi loading
            setTimeout(() => {
                // Muat konten halaman berdasarkan page
                let content = '';
                
                switch(page) {
                    case 'home':
                        content = loadHomePage();
                        break;
                    case 'search':
                        content = loadSearchPage();
                        break;
                    case 'watchlist':
                        content = loadWatchlistPage();
                        break;
                    case 'history':
                        content = loadHistoryPage();
                        break;
                    case 'profile':
                        content = loadProfilePage();
                        break;
                    case 'movie-detail':
                        content = loadMovieDetailPage();
                        break;
                    default:
                        content = loadHomePage();
                }
                
        // Tambahkan animasi transisi
        if (page === 'movie-detail') {
            mainContent.className = 'container-fluid mt-5 pt-5 pb-5 page-transition';
        } else {
            mainContent.className = 'container-fluid mt-5 pt-4 pb-5 page-transition';
        }
        mainContent.innerHTML = content;
                
                // Update bottom navigation
                updateBottomNav(page);
                
                // Jika ada back button, tambahkan event listener
                const backBtn = document.querySelector('.back-button');
                if (backBtn) {
                    backBtn.addEventListener('click', goBack);
                }
                
                // Jika halaman home, inisialisasi carousel
                if (page === 'home') {
                    initCarousel();
                }
            }, 300);
        }
        
        // Fungsi untuk kembali ke halaman sebelumnya
        function goBack() {
            if (pageHistory.length > 0) {
                const prevPage = pageHistory.pop();
                loadPage(prevPage, false);
            } else {
                loadPage('home', false);
            }
        }
        
        // Update bottom navigation
        function updateBottomNav(page) {
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => {
                const icon = item.querySelector('i').className;
                if (icon.includes('home') && page === 'home') {
                    item.classList.add('active');
                } else if (icon.includes('search') && page === 'search') {
                    item.classList.add('active');
                } else if (icon.includes('bookmark') && page === 'watchlist') {
                    item.classList.add('active');
                } else if (icon.includes('user') && page === 'profile') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // ==================== HALAMAN HOME ====================
        function loadHomePage() {
            const session = getSession();
            const userName = session.name || 'Pengguna';
            
            // Ambil film trending (5 film pertama) untuk carousel
            const trendingMovies = movies.slice(0, 5);
            
            // Ambil film terbaru (5 film pertama)
            const newReleases = movies.slice(0, 8);
            
            // Ambil film dengan rating tertinggi
            const topRatedMovies = [...movies].sort((a, b) => b.rating - a.rating).slice(0, 8);
            
            // Ambil film aksi
            const actionMovies = movies.filter(movie => movie.genre.includes('Action')).slice(0, 8);
            
            // Ambil film sci-fi
            const scifiMovies = movies.filter(movie => movie.genre.includes('Sci-Fi')).slice(0, 8);
            
            return `
                <div class="container">
                    <!-- Header dengan sapaan -->
                    <div class="row mb-4 mt-4">
                        <div class="col">
                            <h2 class="fw-bold">Selamat datang, ${userName}</h2>
                            <p class="text-muted">Nikmati film terbaru dan terlengkap hanya di TONTOON</p>
                        </div>
                    </div>
                    
                    <!-- Carousel Film Trending -->
                    <div class="row mb-5">
                        <div class="col">
                            <h4 class="mb-3">🔥 Trending Now</h4>
                            <div class="carousel-trending">
                                ${trendingMovies.map((movie, index) => `
                                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                        <img src="${movie.banner}" class="carousel-image" alt="${movie.title}">
                                        <div class="carousel-overlay">
                                            <h2 class="carousel-title">${movie.title}</h2>
                                            <div class="carousel-info">
                                                <div class="carousel-rating">
                                                    <i class="fas fa-star me-1"></i> ${formatRating(movie.rating)}
                                                </div>
                                                <div class="carousel-year">${movie.year}</div>
                                                <div class="carousel-duration">${movie.duration}</div>
                                            </div>
                                            <div class="carousel-genres">
                                                ${movie.genre.map(g => `<span class="carousel-genre">${g}</span>`).join('')}
                                            </div>
                                            <div class="d-flex gap-3">
                                                <button class="btn btn-primary btn-lg" onclick="playMovie(${movie.id})">
                                                    <i class="fas fa-play me-2"></i> Putar Sekarang
                                                </button>
                                                <button class="btn btn-outline-light btn-lg" onclick="showMovieDetail(${movie.id})">
                                                    <i class="fas fa-info-circle me-2"></i> Detail
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}

                                <!-- Carousel Indicators -->
                                <div class="carousel-indicators-custom">
                                    ${trendingMovies.map((_, index) => `
                                        <div class="carousel-indicator ${index === 0 ? 'active' : ''}" onclick="goToCarousel(${index})"></div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Film Terbaru -->
                    <div class="row mb-5">
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>🎬 Rilisan Terbaru</h4>
                                <a href="#" class="text-primary" onclick="loadPage('search')">Lihat Semua</a>
                            </div>
                            <div class="horizontal-scroll">
                                ${newReleases.map(movie => generateMovieCard(movie)).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Film dengan Rating Tertinggi -->
                    <div class="row mb-5">
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>⭐ Rating Tertinggi</h4>
                                <a href="#" class="text-primary" onclick="loadPage('search')">Lihat Semua</a>
                            </div>
                            <div class="horizontal-scroll">
                                ${topRatedMovies.map(movie => generateMovieCard(movie)).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Film Aksi -->
                    <div class="row mb-5">
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>💥 Film Aksi</h4>
                                <a href="#" class="text-primary" onclick="loadPage('search')">Lihat Semua</a>
                            </div>
                            <div class="horizontal-scroll">
                                ${actionMovies.map(movie => generateMovieCard(movie)).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Film Sci-Fi -->
                    <div class="row mb-5">
                        <div class="col">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>🚀 Film Sci-Fi</h4>
                                <a href="#" class="text-primary" onclick="loadPage('search')">Lihat Semua</a>
                            </div>
                            <div class="horizontal-scroll">
                                ${scifiMovies.map(movie => generateMovieCard(movie)).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Spacer untuk bottom navigation -->
                    <div class="mb-5"></div>
                </div>
            `;
        }
        
        // ==================== FUNGSI CAROUSEL ====================
        let currentCarouselIndex = 0;
        let carouselItems = [];
        
        function initCarousel() {
            carouselItems = document.querySelectorAll('.carousel-item');
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Reset semua item dan indicators
            carouselItems.forEach(item => item.classList.remove('active'));
            indicators.forEach(indicator => indicator.classList.remove('active'));
            
            // Set item pertama sebagai active
            if (carouselItems.length > 0) {
                carouselItems[0].classList.add('active');
                indicators[0].classList.add('active');
                currentCarouselIndex = 0;
            }
            
            // Auto slide setiap 5 detik
            carouselInterval = setInterval(nextCarousel, 5000);
            
            // Tambahkan event listeners untuk swipe di mobile
            const carousel = document.querySelector('.carousel-trending');
            if (carousel) {
                let touchStartX = 0;
                let touchEndX = 0;
                
                carousel.addEventListener('touchstart', e => {
                    touchStartX = e.changedTouches[0].screenX;
                });
                
                carousel.addEventListener('touchend', e => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                });
                
                function handleSwipe() {
                    const swipeThreshold = 50;
                    const diff = touchStartX - touchEndX;
                    
                    if (Math.abs(diff) > swipeThreshold) {
                        if (diff > 0) {
                            // Swipe kiri, next carousel
                            nextCarousel();
                        } else {
                            // Swipe kanan, prev carousel
                            prevCarousel();
                        }
                    }
                }
            }
        }
        
        function nextCarousel() {
            if (carouselItems.length === 0) return;
            
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Sembunyikan item saat ini
            carouselItems[currentCarouselIndex].classList.remove('active');
            indicators[currentCarouselIndex].classList.remove('active');
            
            // Hitung index berikutnya
            currentCarouselIndex = (currentCarouselIndex + 1) % carouselItems.length;
            
            // Tampilkan item berikutnya
            carouselItems[currentCarouselIndex].classList.add('active');
            indicators[currentCarouselIndex].classList.add('active');
            
            // Reset interval
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = setInterval(nextCarousel, 5000);
            }
        }
        
        function prevCarousel() {
            if (carouselItems.length === 0) return;
            
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Sembunyikan item saat ini
            carouselItems[currentCarouselIndex].classList.remove('active');
            indicators[currentCarouselIndex].classList.remove('active');
            
            // Hitung index sebelumnya
            currentCarouselIndex = (currentCarouselIndex - 1 + carouselItems.length) % carouselItems.length;
            
            // Tampilkan item sebelumnya
            carouselItems[currentCarouselIndex].classList.add('active');
            indicators[currentCarouselIndex].classList.add('active');
            
            // Reset interval
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = setInterval(nextCarousel, 5000);
            }
        }
        
        function goToCarousel(index) {
            if (carouselItems.length === 0 || index < 0 || index >= carouselItems.length) return;
            
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            // Sembunyikan item saat ini
            carouselItems[currentCarouselIndex].classList.remove('active');
            indicators[currentCarouselIndex].classList.remove('active');
            
            // Set index baru
            currentCarouselIndex = index;
            
            // Tampilkan item yang dipilih
            carouselItems[currentCarouselIndex].classList.add('active');
            indicators[currentCarouselIndex].classList.add('active');
            
            // Reset interval
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = setInterval(nextCarousel, 5000);
            }
        }
        
        // ==================== HALAMAN SEARCH ====================
        function loadSearchPage() {
            return `
                <div class="container">
                    <!-- Header Search -->
                    <div class="row mb-4 mt-3">
                        <div class="col">
                            <h2 class="fw-bold">Cari Film</h2>
                            <p class="text-muted">Temukan film favorit Anda</p>
                        </div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="row mb-4">
                        <div class="col">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Cari berdasarkan judul, aktor, atau sutradara...">
                                <button class="btn btn-primary" type="button" onclick="performSearch()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="row mb-4">
                        <div class="col">
                            <h5>Filter</h5>
                            <div class="d-flex flex-wrap gap-2">
                                <select class="form-select form-select-sm" id="genreFilter" style="width: auto;">
                                    <option value="">Semua Genre</option>
                                    <option value="Action">Action</option>
                                    <option value="Adventure">Adventure</option>
                                    <option value="Sci-Fi">Sci-Fi</option>
                                    <option value="Drama">Drama</option>
                                    <option value="Thriller">Thriller</option>
                                    <option value="Fantasy">Fantasy</option>
                                    <option value="Comedy">Comedy</option>
                                    <option value="Crime">Crime</option>
                                </select>
                                
                                <select class="form-select form-select-sm" id="yearFilter" style="width: auto;">
                                    <option value="">Semua Tahun</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="2019">2019</option>
                                    <option value="2018">2018</option>
                                </select>
                                
                                <select class="form-select form-select-sm" id="ratingFilter" style="width: auto;">
                                    <option value="">Semua Rating</option>
                                    <option value="9">9+</option>
                                    <option value="8">8+</option>
                                    <option value="7">7+</option>
                                    <option value="6">6+</option>
                                </select>
                                
                                <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()">Terapkan Filter</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div class="row">
                        <div class="col">
                            <h5>Hasil Pencarian</h5>
                            <div class="search-results-container" id="searchResults">
                                <!-- Hasil pencarian akan ditampilkan di sini -->
                                <div class="no-results text-center py-5">
                                    <i class="fas fa-film fa-3x mb-3 text-muted"></i>
                                    <p class="text-muted">Masukkan kata kunci pencarian untuk menemukan film</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Fungsi untuk melakukan pencarian
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.toLowerCase();
            
            if (!query.trim()) {
                alert('Masukkan kata kunci pencarian');
                return;
            }
            
            // Filter film berdasarkan query
            const results = movies.filter(movie => 
                movie.title.toLowerCase().includes(query) ||
                movie.genre.some(g => g.toLowerCase().includes(query))
            );
            
            // Tampilkan hasil
            displaySearchResults(results);
        }
        
        // Fungsi untuk menerapkan filter
        function applyFilters() {
            const genre = document.getElementById('genreFilter').value;
            const year = document.getElementById('yearFilter').value;
            const rating = document.getElementById('ratingFilter').value;
            
            // Filter film
            let results = movies;
            
            if (genre) {
                results = results.filter(movie => movie.genre.includes(genre));
            }
            
            if (year) {
                results = results.filter(movie => movie.year == year);
            }
            
            if (rating) {
                const minRating = parseFloat(rating);
                results = results.filter(movie => movie.rating >= minRating);
            }
            
            // Tampilkan hasil
            displaySearchResults(results);
        }
        
        // Fungsi untuk menampilkan hasil pencarian
        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results text-center py-5">
                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">Tidak ada film yang ditemukan</p>
                    </div>
                `;
                return;
            }

            // Tampilkan hasil dalam grid tanpa Bootstrap grid classes
            let html = '';
            results.forEach(movie => {
                html += generateMovieCard(movie);
            });

            resultsContainer.innerHTML = html;
        }

        // ==================== HALAMAN WATCHLIST ====================
        function loadWatchlistPage() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);
            const watchlist = user ? user.watchlist : [];

            // Ambil film dari watchlist
            let watchlistMovies = movies.filter(movie => watchlist.includes(movie.id));

            // Default sorting: berdasarkan judul secara alfabetis
            watchlistMovies.sort((a, b) => a.title.localeCompare(b.title));

            return `
                <div class="container">
                    <!-- Header -->
                    <div class="row mb-4 mt-3">
                        <div class="col">
                            <h2 class="fw-bold">Watchlist Saya</h2>
                            <p class="text-muted">Film yang sudah Anda simpan untuk ditonton nanti</p>
                        </div>
                    </div>

                    <!-- Sorting and Filter Controls -->
                    ${watchlistMovies.length > 0 ? `
                        <div class="row mb-4">
                            <div class="col">
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div class="d-flex align-items-center">
                                        <label class="me-2 fw-bold">Urutkan:</label>
                                        <select class="form-select form-select-sm" id="watchlistSort" onchange="updateWatchlistView()" style="width: auto;">
                                            <option value="title-asc">Judul A-Z</option>
                                            <option value="title-desc">Judul Z-A</option>
                                            <option value="year-desc">Tahun Terbaru</option>
                                            <option value="year-asc">Tahun Terlama</option>
                                            <option value="rating-desc">Rating Tertinggi</option>
                                            <option value="rating-asc">Rating Terendah</option>
                                        </select>
                                    </div>

                                    <div class="d-flex align-items-center">
                                        <label class="me-2 fw-bold">Filter Genre:</label>
                                        <select class="form-select form-select-sm" id="watchlistGenreFilter" onchange="updateWatchlistView()" style="width: auto;">
                                            <option value="">Semua Genre</option>
                                            <option value="Action">Action</option>
                                            <option value="Adventure">Adventure</option>
                                            <option value="Sci-Fi">Sci-Fi</option>
                                            <option value="Drama">Drama</option>
                                            <option value="Thriller">Thriller</option>
                                            <option value="Fantasy">Fantasy</option>
                                            <option value="Comedy">Comedy</option>
                                            <option value="Crime">Crime</option>
                                        </select>
                                    </div>

                                    <div class="d-flex align-items-center">
                                        <label class="me-2 fw-bold">Tampilan:</label>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary active" id="gridViewBtn" onclick="toggleView('grid')">
                                                <i class="fas fa-th"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" id="listViewBtn" onclick="toggleView('list')">
                                                <i class="fas fa-list"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Watchlist Content -->
                    <div class="row" id="watchlistContent">
                        ${watchlistMovies.length === 0 ? `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-bookmark fa-3x mb-3 text-muted"></i>
                                <p class="text-muted">Watchlist Anda masih kosong</p>
                                <p class="text-muted">Simpan film untuk ditonton nanti dengan menekan tombol bookmark</p>
                            </div>
                        ` : `
                            <div id="watchlistGridView">
                                ${watchlistMovies.map(movie => `
                                    <div class="col-6 col-md-4 col-lg-3 mb-4 watchlist-item" data-movie-id="${movie.id}">
                                        ${generateMovieCard(movie)}
                                    </div>
                                `).join('')}
                            </div>
                            <div id="watchlistListView" style="display: none;">
                                ${watchlistMovies.map(movie => `
                                    <div class="col-12 mb-3 watchlist-item" data-movie-id="${movie.id}">
                                        <div class="d-flex align-items-center p-3 glass rounded">
                                            <img src="${movie.poster}" alt="${movie.title}" class="rounded me-3" style="width: 80px; height: 120px; object-fit: cover;">
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1">${movie.title}</h5>
                                                <p class="mb-1 text-muted">${movie.year} • ${movie.genre.join(', ')} • ${movie.duration}</p>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-warning text-dark me-2">
                                                        <i class="fas fa-star me-1"></i>${formatRating(movie.rating)}
                                                    </span>
                                                    <small class="text-muted">${movie.director || 'Unknown'}</small>
                                                </div>
                                            </div>
                                            <div class="d-flex flex-column gap-2">
                                                <button class="btn btn-primary btn-sm" onclick="playMovie(${movie.id})">
                                                    <i class="fas fa-play me-1"></i> Putar
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromWatchlist(${movie.id})">
                                                    <i class="fas fa-trash me-1"></i> Hapus
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // ==================== HALAMAN HISTORY ====================
        function loadHistoryPage() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);
            const history = user ? user.history : [];

            // Ambil film dari history (dibalik urutannya agar yang terbaru muncul pertama)
            let historyMovies = movies.filter(movie => history.includes(movie.id));

            // Default sorting: berdasarkan urutan history (terbaru dulu)
            historyMovies.reverse();

            return `
                <div class="container">
                    <!-- Header -->
                    <div class="row mb-4 mt-3">
                        <div class="col">
                            <h2 class="fw-bold">Riwayat Tontonan</h2>
                            <p class="text-muted">Film yang sudah Anda tonton</p>
                        </div>
                    </div>

                    <!-- Controls -->
                    ${historyMovies.length > 0 ? `
                        <div class="row mb-4">
                            <div class="col">
                                <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
                                    <div class="d-flex flex-wrap gap-3 align-items-center">
                                        <div class="d-flex align-items-center">
                                            <label class="me-2 fw-bold">Urutkan:</label>
                                            <select class="form-select form-select-sm" id="historySort" onchange="updateHistoryView()" style="width: auto;">
                                                <option value="recent">Terbaru Dulu</option>
                                                <option value="oldest">Terlama Dulu</option>
                                                <option value="title-asc">Judul A-Z</option>
                                                <option value="title-desc">Judul Z-A</option>
                                                <option value="year-desc">Tahun Terbaru</option>
                                                <option value="year-asc">Tahun Terlama</option>
                                                <option value="rating-desc">Rating Tertinggi</option>
                                                <option value="rating-asc">Rating Terendah</option>
                                            </select>
                                        </div>

                                        <div class="d-flex align-items-center">
                                            <label class="me-2 fw-bold">Filter Genre:</label>
                                            <select class="form-select form-select-sm" id="historyGenreFilter" onchange="updateHistoryView()" style="width: auto;">
                                                <option value="">Semua Genre</option>
                                                <option value="Action">Action</option>
                                                <option value="Adventure">Adventure</option>
                                                <option value="Sci-Fi">Sci-Fi</option>
                                                <option value="Drama">Drama</option>
                                                <option value="Thriller">Thriller</option>
                                                <option value="Fantasy">Fantasy</option>
                                                <option value="Comedy">Comedy</option>
                                                <option value="Crime">Crime</option>
                                            </select>
                                        </div>

                                        <div class="d-flex align-items-center">
                                            <label class="me-2 fw-bold">Tampilan:</label>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary active" id="historyGridViewBtn" onclick="toggleHistoryView('grid')">
                                                    <i class="fas fa-th"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-primary" id="historyListViewBtn" onclick="toggleHistoryView('list')">
                                                    <i class="fas fa-list"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="btn btn-outline-danger btn-sm" onclick="clearHistory()">
                                        <i class="fas fa-trash me-1"></i> Hapus Semua
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- History Content -->
                    <div class="row" id="historyContent">
                        ${historyMovies.length === 0 ? `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-history fa-3x mb-3 text-muted"></i>
                                <p class="text-muted">Riwayat tontonan Anda masih kosong</p>
                                <p class="text-muted">Mulai menonton film untuk mengisi riwayat</p>
                            </div>
                        ` : `
                            <div id="historyGridView">
                                ${historyMovies.map(movie => `
                                    <div class="col-6 col-md-4 col-lg-3 mb-4 history-item" data-movie-id="${movie.id}">
                                        <div class="movie-card shared-transition" onclick="showMovieDetail(${movie.id})">
                                            <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
                                            <div class="movie-overlay">
                                                <div class="movie-title">${movie.title}</div>
                                                <div class="movie-meta">
                                                    <span>${movie.year}</span> •
                                                    <span><i class="fas fa-star text-warning"></i> ${formatRating(movie.rating)}</span> •
                                                    <span>${movie.genre[0]}</span>
                                                </div>
                                            </div>
                                            <div class="position-absolute top-0 end-0 m-2">
                                                <span class="badge bg-success">
                                                    <i class="fas fa-eye me-1"></i>Ditonton
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div id="historyListView" style="display: none;">
                                ${historyMovies.map(movie => `
                                    <div class="col-12 mb-3 history-item" data-movie-id="${movie.id}">
                                        <div class="d-flex align-items-center p-3 glass rounded position-relative">
                                            <img src="${movie.poster}" alt="${movie.title}" class="rounded me-3" style="width: 80px; height: 120px; object-fit: cover;">
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1">${movie.title}</h5>
                                                <p class="mb-1 text-muted">${movie.year} • ${movie.genre.join(', ')} • ${movie.duration}</p>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-warning text-dark me-2">
                                                        <i class="fas fa-star me-1"></i>${formatRating(movie.rating)}
                                                    </span>
                                                    <small class="text-muted">${movie.director || 'Unknown'}</small>
                                                </div>
                                            </div>
                                            <div class="d-flex flex-column gap-2">
                                                <button class="btn btn-primary btn-sm" onclick="playMovie(${movie.id})">
                                                    <i class="fas fa-play me-1"></i> Putar Lagi
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromHistory(${movie.id})">
                                                    <i class="fas fa-trash me-1"></i> Hapus
                                                </button>
                                            </div>
                                            <div class="position-absolute top-0 end-0 m-2">
                                                <span class="badge bg-success">
                                                    <i class="fas fa-eye me-1"></i>Ditonton
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // ==================== HALAMAN PROFILE ====================
        function loadProfilePage() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);

            if (!user) {
                showLoginModal();
                return '';
            }

            const joinDate = new Date(user.joinDate).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const isLightTheme = currentTheme === 'light';

            return `
                <div class="container">
                    <!-- Profile Header -->
                    <div class="row mb-5 mt-3">
                        <div class="col-12 col-md-8 mx-auto">
                            <div class="d-flex flex-column align-items-center">
                                <div class="position-relative mb-3">
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; overflow: hidden;">
                                        ${user.profilePicture ?
                                            `<img src="${user.profilePicture}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover;">` :
                                            `<i class="fas fa-user fa-3x"></i>`
                                        }
                                    </div>
                                    <button class="btn btn-sm btn-primary rounded-circle position-absolute" style="bottom: 0; right: 0; width: 30px; height: 30px;" onclick="showUploadPhoto()">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                                <h3 class="fw-bold">${user.name}</h3>
                                <p class="text-muted">${user.email}</p>
                                <p class="text-muted">Member sejak ${joinDate}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Stats -->
                    <div class="row mb-5">
                        <div class="col">
                            <h5 class="mb-4">Statistik</h5>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="p-3 rounded glass">
                                        <h3 class="fw-bold">${user.watchlist ? user.watchlist.length : 0}</h3>
                                        <p class="mb-0">Watchlist</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 rounded glass">
                                        <h3 class="fw-bold">${user.history ? user.history.length : 0}</h3>
                                        <p class="mb-0">Ditonton</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 rounded glass">
                                        <h3 class="fw-bold">${movies.length}</h3>
                                        <p class="mb-0">Film Tersedia</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Settings -->
                    <div class="row mb-4">
                        <div class="col">
                            <h5 class="mb-4">Pengaturan</h5>
                            <div class="list-group">
                                <a href="#" class="list-group-item list-group-item-action glass border-0 mb-2" onclick="showEditProfile()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-user-edit me-3"></i>
                                            Edit Profil
                                        </div>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>

                                <a href="#" class="list-group-item list-group-item-action glass border-0 mb-2" onclick="showChangePassword()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-key me-3"></i>
                                            Ubah Password
                                        </div>
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>

                                <div class="list-group-item glass border-0 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-palette me-3"></i>
                                            Tema
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="themeSwitch" onchange="toggleTheme()" ${isLightTheme ? 'checked' : ''}>
                                        </div>
                                    </div>
                                </div>

                                <div class="list-group-item glass border-0 mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-bell me-3"></i>
                                            Notifikasi
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="notifSwitch" checked>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logout Button -->
                    <div class="row">
                        <div class="col">
                            <div class="d-grid">
                                <button class="btn btn-danger btn-lg" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==================== HALAMAN DETAIL FILM ====================
        function showMovieDetail(movieId) {
            // Tambahkan film ke history jika user sudah login
            if (isLoggedIn()) {
                const session = getSession();
                const users = getUsers();
                const userIndex = users.findIndex(u => u.id === session.userId);
                
                if (userIndex !== -1) {
                    // Tambahkan ke history jika belum ada
                    if (!users[userIndex].history.includes(movieId)) {
                        users[userIndex].history.push(movieId);
                        saveUsers(users);
                    }
                }
            }
            
            // Set movie detail page dan muat
            localStorage.setItem('currentMovieId', movieId);
            loadPage('movie-detail');
        }
        
        function loadMovieDetailPage() {
            const movieId = parseInt(localStorage.getItem('currentMovieId')) || 1;
            const movie = movies.find(m => m.id === movieId) || movies[0];
            
            // Cek apakah film ada di watchlist user
            let isInWatchlist = false;
            if (isLoggedIn()) {
                const session = getSession();
                const users = getUsers();
                const user = users.find(u => u.id === session.userId);
                isInWatchlist = user && user.watchlist.includes(movieId);
            }
            
            return `
                <div class="container">
                    <!-- Movie Detail -->
                    <div class="row mb-5">
                        <div class="col-12 col-md-4 mb-4 mb-md-0">
                            <img src="${movie.poster}" alt="${movie.title}" class="img-fluid rounded" style="max-height: 500px;">
                        </div>
                        <div class="col-12 col-md-8">
                            <h1 class="fw-bold mb-3">${movie.title} (${movie.year})</h1>
                            
                            <div class="d-flex align-items-center mb-4">
                                <div class="bg-warning text-dark px-3 py-1 rounded me-3">
                                    <i class="fas fa-star me-1"></i> ${formatRating(movie.rating)}
                                </div>
                                <div class="me-3">${movie.duration}</div>
                                <div>
                                    ${movie.genre.map(g => `<span class="badge bg-primary me-1">${g}</span>`).join('')}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5 class="mb-2">Sinopsis</h5>
                                <p>${movie.description}</p>
                            </div>
                            
                            <div class="d-flex flex-wrap gap-3 mb-4">
                                <button class="btn btn-primary btn-lg" onclick="playMovie(${movieId})">
                                    <i class="fas fa-play me-2"></i> Putar Sekarang
                                </button>
                                
                                <button class="btn ${isInWatchlist ? 'btn-success' : 'btn-outline-primary'} btn-lg" id="watchlistBtn" onclick="toggleWatchlist(${movieId})">
                                    <i class="fas ${isInWatchlist ? 'fa-check' : 'fa-bookmark'} me-2"></i> 
                                    ${isInWatchlist ? 'Di Watchlist' : 'Simpan ke Watchlist'}
                                </button>
                                
                                <button class="btn btn-outline-primary btn-lg" onclick="shareMovie(${movieId})">
                                    <i class="fas fa-share me-2"></i> Bagikan
                                </button>
                            </div>
                            
                            <div>
                                <h5 class="mb-3">Detail Film</h5>
                                <table class="table table-borderless">
                                    <tr>
                                        <td style="width: 30%"><strong>Director</strong></td>
                                        <td>${movie.director || 'Unknown'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Cast</strong></td>
                                        <td>${movie.cast || 'Unknown'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Release Date</strong></td>
                                        <td>${movie.releaseDate || movie.year}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Language</strong></td>
                                        <td>${movie.language || 'English'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Similar Movies -->
                    <div class="row">
                        <div class="col">
                            <h4 class="mb-3">Film Serupa</h4>
                            <div class="horizontal-scroll">
                                ${movies
                                    .filter(m => m.id !== movieId && m.genre.some(g => movie.genre.includes(g)))
                                    .slice(0, 6)
                                    .map(m => generateMovieCard(m)).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Player (tersembunyi) -->
                    <div class="modal fade" id="videoPlayerModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content bg-dark">
                                <div class="modal-header border-0">
                                    <h5 class="modal-title text-white">${movie.title}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body p-0">
                                    <div class="video-player-container">
                                        <video class="video-player" id="moviePlayer" controls>
                                            <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                        <div class="video-controls">
                                            <!-- Controls akan ditambahkan di sini -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Fungsi untuk memutar film
        function playMovie(movieId) {
            const videoModal = new bootstrap.Modal(document.getElementById('videoPlayerModal'));
            videoModal.show();
            
            // Mulai pemutaran video
            const videoPlayer = document.getElementById('moviePlayer');
            if (videoPlayer) {
                videoPlayer.play();
                
                // Implementasi double-tap untuk skip
                let lastTap = 0;
                videoPlayer.addEventListener('touchend', function(event) {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    
                    if (tapLength < 300 && tapLength > 0) {
                        // Double tap detected
                        const rect = videoPlayer.getBoundingClientRect();
                        const tapX = event.changedTouches[0].clientX - rect.left;
                        
                        // Jika tap di sisi kanan, maju 10 detik
                        // Jika tap di sisi kiri, mundur 10 detik
                        if (tapX < rect.width / 2) {
                            videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
                        } else {
                            videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
                        }
                    }
                    
                    lastTap = currentTime;
                });
            }
        }
        
        // Fungsi untuk toggle watchlist
        function toggleWatchlist(movieId) {
            if (!isLoggedIn()) {
                showLoginModal();
                return;
            }

            const session = getSession();
            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === session.userId);

            if (userIndex === -1) return;

            const watchlist = users[userIndex].watchlist;
            const isInWatchlist = watchlist.includes(movieId);

            if (isInWatchlist) {
                // Hapus dari watchlist
                users[userIndex].watchlist = watchlist.filter(id => id !== movieId);
            } else {
                // Tambah ke watchlist
                users[userIndex].watchlist.push(movieId);
            }

            saveUsers(users);

            // Update tombol
            const watchlistBtn = document.getElementById('watchlistBtn');
            if (watchlistBtn) {
                if (isInWatchlist) {
                    watchlistBtn.className = 'btn btn-outline-primary btn-lg';
                    watchlistBtn.innerHTML = '<i class="fas fa-bookmark me-2"></i> Simpan ke Watchlist';
                } else {
                    watchlistBtn.className = 'btn btn-success btn-lg';
                    watchlistBtn.innerHTML = '<i class="fas fa-check me-2"></i> Di Watchlist';
                }
            }
        }

        // Fungsi untuk membagikan film
        function shareMovie(movieId) {
            const movie = movies.find(m => m.id === movieId);
            if (!movie) return;

            const shareData = {
                title: movie.title,
                text: `Tonton ${movie.title} di TONTOON! Rating: ${movie.rating}/10`,
                url: window.location.href + '?movie=' + movieId
            };

            // Cek apakah Web Share API didukung
            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => console.log('Berhasil membagikan'))
                    .catch((error) => console.log('Error sharing:', error));
            } else {
                // Fallback: copy URL ke clipboard
                const shareUrl = shareData.url;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Link film berhasil disalin ke clipboard!\n\n' + shareUrl);
                }).catch(() => {
                    // Fallback jika clipboard tidak didukung
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Link film berhasil disalin ke clipboard!\n\n' + shareUrl);
                });
            }
        }
        
        // ==================== FUNGSI EDIT PROFILE ====================
        function showEditProfile() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);
            
            if (!user) return;
            
            // Buat modal edit profile
            const modalHTML = `
                <div class="modal fade" id="editProfileModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content glass border-0">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Edit Profil</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editProfileForm">
                                    <div class="mb-3">
                                        <label for="editName" class="form-label">Nama Lengkap</label>
                                        <input type="text" class="form-control" id="editName" value="${user.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="editEmail" value="${user.email}" required>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Tambahkan modal ke body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Tampilkan modal
            const editProfileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            editProfileModal.show();
            
            // Tambahkan event listener untuk form
            document.getElementById('editProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newName = document.getElementById('editName').value;
                const newEmail = document.getElementById('editEmail').value;
                
                // Validasi email
                if (!newEmail.includes('@')) {
                    alert('Email tidak valid');
                    return;
                }
                
                // Update user data
                const updatedUsers = users.map(u => {
                    if (u.id === user.id) {
                        return {
                            ...u,
                            name: newName,
                            email: newEmail
                        };
                    }
                    return u;
                });
                
                saveUsers(updatedUsers);
                
                // Update session
                const updatedSession = {
                    ...session,
                    name: newName,
                    email: newEmail
                };
                saveSession(updatedSession);
                
                // Tutup modal
                editProfileModal.hide();
                
                // Hapus modal dari DOM
                document.getElementById('editProfileModal').remove();
                
                // Reload halaman profile
                loadPage('profile');
                
                alert('Profil berhasil diperbarui!');
            });
            
            // Hapus modal dari DOM saat ditutup
            document.getElementById('editProfileModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
        
        // ==================== FUNGSI UPLOAD PHOTO ====================
        function showUploadPhoto() {
            // Buat modal upload photo
            const modalHTML = `
                <div class="modal fade" id="uploadPhotoModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content glass border-0">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Upload Foto Profil</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="uploadPhotoForm">
                                    <div class="mb-3">
                                        <label for="photoInput" class="form-label">Pilih Foto</label>
                                        <input type="file" class="form-control" id="photoInput" accept="image/*" required>
                                        <div class="form-text">Format: JPG, PNG, GIF. Maksimal 5MB</div>
                                    </div>
                                    <div class="mb-3 text-center">
                                        <img id="photoPreview" src="" alt="Preview" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover; display: none;">
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">Upload Foto</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Tambahkan modal ke body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Tampilkan modal
            const uploadPhotoModal = new bootstrap.Modal(document.getElementById('uploadPhotoModal'));
            uploadPhotoModal.show();

            // Preview foto saat dipilih
            document.getElementById('photoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('photoPreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Tambahkan event listener untuk form
            document.getElementById('uploadPhotoForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const fileInput = document.getElementById('photoInput');
                const file = fileInput.files[0];

                if (!file) {
                    alert('Pilih foto terlebih dahulu');
                    return;
                }

                // Validasi ukuran file (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ukuran file maksimal 5MB');
                    return;
                }

                // Validasi tipe file
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Format file tidak didukung. Gunakan JPG, PNG, atau GIF');
                    return;
                }

                // Convert ke base64 dan simpan
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64String = e.target.result;

                    // Update user data
                    const session = getSession();
                    const users = getUsers();
                    const userIndex = users.findIndex(u => u.id === session.userId);

                    if (userIndex !== -1) {
                        users[userIndex].profilePicture = base64String;
                        saveUsers(users);

                        // Tutup modal
                        uploadPhotoModal.hide();

                        // Hapus modal dari DOM
                        document.getElementById('uploadPhotoModal').remove();

                        // Reload halaman profile
                        loadPage('profile');

                        alert('Foto profil berhasil diupload!');
                    }
                };
                reader.readAsDataURL(file);
            });

            // Hapus modal dari DOM saat ditutup
            document.getElementById('uploadPhotoModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // ==================== FUNGSI CHANGE PASSWORD ====================
        function showChangePassword() {
            // Buat modal change password
            const modalHTML = `
                <div class="modal fade" id="changePasswordModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content glass border-0">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Ubah Password</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="changePasswordForm">
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">Password Saat Ini</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">Password Baru</label>
                                        <input type="password" class="form-control" id="newPassword" minlength="6" required>
                                        <div class="form-text">Password minimal 6 karakter</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirmNewPassword" class="form-label">Konfirmasi Password Baru</label>
                                        <input type="password" class="form-control" id="confirmNewPassword" required>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">Ubah Password</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Tambahkan modal ke body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Tampilkan modal
            const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            changePasswordModal.show();

            // Tambahkan event listener untuk form
            document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                // Validasi
                if (newPassword !== confirmNewPassword) {
                    alert('Password baru tidak cocok');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('Password baru minimal 6 karakter');
                    return;
                }

                const session = getSession();
                const users = getUsers();
                const userIndex = users.findIndex(u => u.id === session.userId);

                if (userIndex === -1) {
                    alert('User tidak ditemukan');
                    return;
                }

                // Cek password saat ini
                if (users[userIndex].password !== simpleHash(currentPassword)) {
                    alert('Password saat ini salah');
                    return;
                }

                // Update password
                users[userIndex].password = simpleHash(newPassword);
                saveUsers(users);

                // Tutup modal
                changePasswordModal.hide();

                // Hapus modal dari DOM
                document.getElementById('changePasswordModal').remove();

                alert('Password berhasil diubah!');
            });

            // Hapus modal dari DOM saat ditutup
            document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // ==================== FUNGSI WATCHLIST MANAGEMENT ====================
        // Fungsi untuk update watchlist view (sorting dan filtering)
        function updateWatchlistView() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);
            const watchlist = user ? user.watchlist : [];

            // Ambil film dari watchlist
            let watchlistMovies = movies.filter(movie => watchlist.includes(movie.id));

            // Apply sorting
            const sortValue = document.getElementById('watchlistSort').value;
            watchlistMovies.sort((a, b) => {
                switch(sortValue) {
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'year-desc':
                        return b.year - a.year;
                    case 'year-asc':
                        return a.year - b.year;
                    case 'rating-desc':
                        return b.rating - a.rating;
                    case 'rating-asc':
                        return a.rating - b.rating;
                    default:
                        return a.title.localeCompare(b.title);
                }
            });

            // Apply filtering
            const genreValue = document.getElementById('watchlistGenreFilter').value;
            if (genreValue) {
                watchlistMovies = watchlistMovies.filter(movie => movie.genre.includes(genreValue));
            }

            // Update grid view
            const gridView = document.getElementById('watchlistGridView');
            if (gridView) {
                gridView.innerHTML = watchlistMovies.map(movie => `
                    <div class="col-6 col-md-4 col-lg-3 mb-4 watchlist-item" data-movie-id="${movie.id}">
                        ${generateMovieCard(movie)}
                    </div>
                `).join('');
            }

            // Update list view
            const listView = document.getElementById('watchlistListView');
            if (listView) {
                listView.innerHTML = watchlistMovies.map(movie => `
                    <div class="col-12 mb-3 watchlist-item" data-movie-id="${movie.id}">
                        <div class="d-flex align-items-center p-3 glass rounded">
                            <img src="${movie.poster}" alt="${movie.title}" class="rounded me-3" style="width: 80px; height: 120px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <h5 class="mb-1">${movie.title}</h5>
                                <p class="mb-1 text-muted">${movie.year} • ${movie.genre.join(', ')} • ${movie.duration}</p>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-warning text-dark me-2">
                                        <i class="fas fa-star me-1"></i>${formatRating(movie.rating)}
                                    </span>
                                    <small class="text-muted">${movie.director || 'Unknown'}</small>
                                </div>
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-primary btn-sm" onclick="playMovie(${movie.id})">
                                    <i class="fas fa-play me-1"></i> Putar
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromWatchlist(${movie.id})">
                                    <i class="fas fa-trash me-1"></i> Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Fungsi untuk toggle view (grid/list)
        function toggleView(viewType) {
            const gridView = document.getElementById('watchlistGridView');
            const listView = document.getElementById('watchlistListView');
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            if (viewType === 'grid') {
                gridView.style.display = '';
                listView.style.display = 'none';
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                gridView.style.display = 'none';
                listView.style.display = '';
                gridBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
        }

        // Fungsi untuk menghapus film dari watchlist
        function removeFromWatchlist(movieId) {
            if (!confirm('Apakah Anda yakin ingin menghapus film ini dari watchlist?')) {
                return;
            }

            const session = getSession();
            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === session.userId);

            if (userIndex === -1) return;

            // Hapus dari watchlist
            users[userIndex].watchlist = users[userIndex].watchlist.filter(id => id !== movieId);
            saveUsers(users);

            // Hapus elemen dari DOM
            const item = document.querySelector(`[data-movie-id="${movieId}"]`);
            if (item) {
                item.remove();
            }

            // Update statistik di profile jika sedang di halaman profile
            if (currentPage === 'profile') {
                loadPage('profile');
            }

            alert('Film berhasil dihapus dari watchlist!');
        }

        // ==================== FUNGSI HISTORY MANAGEMENT ====================
        // Fungsi untuk update history view (sorting dan filtering)
        function updateHistoryView() {
            const session = getSession();
            const users = getUsers();
            const user = users.find(u => u.id === session.userId);
            const history = user ? user.history : [];

            // Ambil film dari history
            let historyMovies = movies.filter(movie => history.includes(movie.id));

            // Apply sorting
            const sortValue = document.getElementById('historySort').value;
            historyMovies.sort((a, b) => {
                switch(sortValue) {
                    case 'recent':
                        // Default: recent first (reverse the array)
                        return history.indexOf(b.id) - history.indexOf(a.id);
                    case 'oldest':
                        // Oldest first
                        return history.indexOf(a.id) - history.indexOf(b.id);
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'year-desc':
                        return b.year - a.year;
                    case 'year-asc':
                        return a.year - b.year;
                    case 'rating-desc':
                        return b.rating - a.rating;
                    case 'rating-asc':
                        return a.rating - b.rating;
                    default:
                        return history.indexOf(b.id) - history.indexOf(a.id);
                }
            });

            // Apply filtering
            const genreValue = document.getElementById('historyGenreFilter').value;
            if (genreValue) {
                historyMovies = historyMovies.filter(movie => movie.genre.includes(genreValue));
            }

            // Update grid view
            const gridView = document.getElementById('historyGridView');
            if (gridView) {
                gridView.innerHTML = historyMovies.map(movie => `
                    <div class="col-6 col-md-4 col-lg-3 mb-4 history-item" data-movie-id="${movie.id}">
                        <div class="movie-card shared-transition" onclick="showMovieDetail(${movie.id})">
                            <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
                            <div class="movie-overlay">
                                <div class="movie-title">${movie.title}</div>
                                <div class="movie-meta">
                                    <span>${movie.year}</span> •
                                    <span><i class="fas fa-star text-warning"></i> ${formatRating(movie.rating)}</span> •
                                    <span>${movie.genre[0]}</span>
                                </div>
                            </div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-success">
                                    <i class="fas fa-eye me-1"></i>Ditonton
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update list view
            const listView = document.getElementById('historyListView');
            if (listView) {
                listView.innerHTML = historyMovies.map(movie => `
                    <div class="col-12 mb-3 history-item" data-movie-id="${movie.id}">
                        <div class="d-flex align-items-center p-3 glass rounded position-relative">
                            <img src="${movie.poster}" alt="${movie.title}" class="rounded me-3" style="width: 80px; height: 120px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <h5 class="mb-1">${movie.title}</h5>
                                <p class="mb-1 text-muted">${movie.year} • ${movie.genre.join(', ')} • ${movie.duration}</p>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-warning text-dark me-2">
                                        <i class="fas fa-star me-1"></i>${formatRating(movie.rating)}
                                    </span>
                                    <small class="text-muted">${movie.director || 'Unknown'}</small>
                                </div>
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-primary btn-sm" onclick="playMovie(${movie.id})">
                                    <i class="fas fa-play me-1"></i> Putar Lagi
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromHistory(${movie.id})">
                                    <i class="fas fa-trash me-1"></i> Hapus
                                </button>
                            </div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-success">
                                    <i class="fas fa-eye me-1"></i>Ditonton
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Fungsi untuk toggle view (grid/list) untuk history
        function toggleHistoryView(viewType) {
            const gridView = document.getElementById('historyGridView');
            const listView = document.getElementById('historyListView');
            const gridBtn = document.getElementById('historyGridViewBtn');
            const listBtn = document.getElementById('historyListViewBtn');

            if (viewType === 'grid') {
                gridView.style.display = '';
                listView.style.display = 'none';
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                gridView.style.display = 'none';
                listView.style.display = '';
                gridBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
        }

        // Fungsi untuk clear history
        function clearHistory() {
            if (!confirm('Apakah Anda yakin ingin menghapus semua riwayat tontonan? Tindakan ini tidak dapat dibatalkan.')) {
                return;
            }

            const session = getSession();
            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === session.userId);

            if (userIndex === -1) return;

            // Clear history
            users[userIndex].history = [];
            saveUsers(users);

            // Reload halaman history
            loadPage('history');

            alert('Riwayat tontonan berhasil dihapus!');
        }

        // Fungsi untuk menghapus film dari history
        function removeFromHistory(movieId) {
            if (!confirm('Apakah Anda yakin ingin menghapus film ini dari riwayat?')) {
                return;
            }

            const session = getSession();
            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === session.userId);

            if (userIndex === -1) return;

            // Hapus dari history
            users[userIndex].history = users[userIndex].history.filter(id => id !== movieId);
            saveUsers(users);

            // Hapus elemen dari DOM
            const item = document.querySelector(`[data-movie-id="${movieId}"]`);
            if (item) {
                item.remove();
            }

            // Update statistik di profile jika sedang di halaman profile
            if (currentPage === 'profile') {
                loadPage('profile');
            }

            alert('Film berhasil dihapus dari riwayat!');
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Inisialisasi aplikasi
            initUsers();
            initModals();
            loadTheme();
            
            // Event listener untuk tema toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Event listener untuk form login
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                // Validasi email
                if (!email.includes('@')) {
                    alert('Email tidak valid');
                    return;
                }
                
                // Cari user
                const users = getUsers();
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    alert('Email tidak terdaftar');
                    return;
                }
                
                // Cek password
                if (user.password !== simpleHash(password)) {
                    alert('Password salah');
                    return;
                }
                
                // Login berhasil
                saveSession(user);
                
                if (rememberMe) {
                    localStorage.setItem('tontoon_remember', 'true');
                }
                
                // Tutup modal
                loginModal.hide();
                
                // Load halaman home
                loadPage('home');
                
                alert('Login berhasil! Selamat datang ' + user.name);
            });
            
            // Event listener untuk form register
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                
                // Validasi
                if (!name.trim()) {
                    alert('Nama tidak boleh kosong');
                    return;
                }
                
                if (!email.includes('@')) {
                    alert('Email tidak valid');
                    return;
                }
                
                if (password.length < 6) {
                    alert('Password minimal 6 karakter');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('Password tidak cocok');
                    return;
                }
                
                // Cek apakah email sudah terdaftar
                const users = getUsers();
                const existingUser = users.find(u => u.email === email);
                
                if (existingUser) {
                    alert('Email sudah terdaftar');
                    return;
                }
                
                // Buat user baru
                const newUser = {
                    id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                    name: name,
                    email: email,
                    password: simpleHash(password),
                    joinDate: new Date().toISOString(),
                    watchlist: [],
                    history: [],
                    preferences: {
                        theme: "dark",
                        autoPlay: true,
                        quality: "720p"
                    }
                };
                
                // Tambahkan user
                users.push(newUser);
                saveUsers(users);
                
                // Login otomatis
                saveSession(newUser);
                
                // Tutup modal
                registerModal.hide();
                
                // Load halaman home
                loadPage('home');
                
                alert('Registrasi berhasil! Selamat datang di TONTOON');
            });
            
            // Event listener untuk form forgot password
            document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('forgotEmail').value;
                
                // Cek apakah email terdaftar
                const users = getUsers();
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    alert('Email tidak terdaftar');
                    return;
                }
                
                // Simulasi pengiriman email reset password
                alert('Link reset password telah dikirim ke email ' + email);
                
                // Tutup modal
                forgotPasswordModal.hide();
                showLogin();
            });
            
            // Cek apakah user sudah login
            if (isLoggedIn()) {
                // Update mobile profile image
                updateMobileProfileImage();
                // Auto load home page
                loadPage('home');
            } else {
                // Tampilkan modal login
                setTimeout(() => {
                    showLoginModal();
                }, 500);
            }
            
            // Implementasi pull-to-refresh
            let touchStartY = 0;
            document.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', function(e) {
                const touchEndY = e.changedTouches[0].clientY;
                const diff = touchStartY - touchEndY;
                
                // Jika user menarik ke bawah cukup jauh dari atas halaman
                if (diff < -100 && window.scrollY === 0) {
                    // Reload halaman
                    loadPage(currentPage, false);
                }
            });
            
            // Push Notifications Simulation
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 3000);
            }
            
            // Simulasi notifikasi film baru setiap 30 detik (untuk demo)
            setInterval(() => {
                if (isLoggedIn() && Notification.permission === 'granted' && currentPage === 'home') {
                    const randomMovie = movies[Math.floor(Math.random() * movies.length)];
                    new Notification('TONTOON - Film Baru!', {
                        body: `${randomMovie.title} tersedia untuk ditonton!`,
                        icon: 'https://via.placeholder.com/128/7A1CAC/FFFFFF?text=T'
                    });
                }
            }, 30000);
        });
        
        // ==================== SERVICE WORKER ====================
        // Service Worker code untuk PWA
        const serviceWorkerCode = `
            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open('tontoon-v1').then(cache => {
                        return cache.addAll([
                            '/',
                            '/index.html',
                            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css',
                            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                            'https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap',
                            'https://via.placeholder.com/300x450/AD49E1/FFFFFF?text=Avengers'
                        ]);
                    })
                );
            });
            
            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request).then(response => {
                        return response || fetch(event.request);
                    })
                );
            });
            
            self.addEventListener('activate', event => {
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.filter(cacheName => cacheName !== 'tontoon-v1')
                                .map(cacheName => caches.delete(cacheName))
                        );
                    })
                );
            });
        `;
        
        // Buat service worker secara dinamis
        if ('serviceWorker' in navigator) {
            const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const swURL = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swURL)
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
